<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMNIF | Core DAO Mainnet</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { createThirdwebClient, getContract, prepareContractCall, sendTransaction, defineChain } from "https://esm.sh/thirdweb";
        import { createWallet } from "https://esm.sh/thirdweb/wallets";

        // ============================================================
        // [SENTINEL CONFIGURATION] - CORE DAO EDITION
        // ============================================================
        const CONFIG = {
            AUTHORIZED_IP: "105.119.7.69", // Updated to your current IP
            ADMIN_WALLET: "0x88d585bd60be1349dd1c6c217d27f87b0351fd0e".toLowerCase(),
            CONTRACT_ADDR: "0xc23F43FE5D5D65b0a094c8A8A712aBd4e820A210", // MUST be on Core DAO!
            DORMANCY_LIMIT: 30 * 24 * 60 * 60 * 1000 
        };
        // ============================================================

        const client = createThirdwebClient({ clientId: "53986b5e6984bcd49129531efe1c149c" });
        
        // Define Core DAO Mainnet (Chain ID 1116)
        const coreChain = defineChain(1116);
        
        const contract = getContract({ client, chain: coreChain, address: CONFIG.CONTRACT_ADDR });

        // --- THE SENTINEL CLASS ---
        class Sentinel {
            constructor() {
                this.dom = {
                    body: document.getElementById('appBody'),
                    log: document.getElementById('nodeLog'),
                    ticker: document.getElementById('vitalityTicker'),
                    ui: document.getElementById('ui'),
                    bootBtn: document.getElementById('bootBtn')
                };
                this.state = localStorage.getItem('SENTINEL_STATE') || 'ACTIVE';
            }

            async init() {
                if (this.state === 'TERMINATED') {
                    this.enforceLockout("PRIOR_SECURITY_EVENT");
                    return;
                }

                const ip = await this.getIP();
                if (ip !== CONFIG.AUTHORIZED_IP) {
                    this.renderDecoy();
                    return;
                }

                const lastPulse = localStorage.getItem('SENTINEL_PULSE');
                if (lastPulse && (Date.now() - parseInt(lastPulse) > CONFIG.DORMANCY_LIMIT)) {
                    this.terminate("DORMANCY_PROTOCOL_EXCEEDED");
                    return;
                }

                this.dom.bootBtn.style.display = 'block';
                this.startTicker();
            }

            async getIP() {
                try {
                    const res = await fetch('https://api.ipify.org?format=json');
                    const data = await res.json();
                    return data.ip;
                } catch { return "0.0.0.0"; }
            }

            renderDecoy() {
                this.dom.body.innerHTML = `
                    <div class="stealth-layer">
                        <h1>503 Service Unavailable</h1>
                        <p>The server is currently unable to handle the request due to a temporary overloading or maintenance of the server.</p>
                    </div>`;
            }

            terminate(reason) {
                localStorage.clear();
                sessionStorage.clear();
                localStorage.setItem('SENTINEL_STATE', 'TERMINATED');
                this.enforceLockout(reason);
            }

            enforceLockout(reason) {
                this.dom.body.innerHTML = `
                    <div class="dead-screen">
                        <div class="sentinel-box">
                            <h1>[SENTINEL_INTERVENTION]</h1>
                            <p>THREAT_DETECTED: ${reason}</p>
                            <div class="scan-line"></div>
                            <p class="sub-text">NODE_ISOLATED // DATA_PURGED</p>
                        </div>
                    </div>`;
            }

            pulse() {
                localStorage.setItem('SENTINEL_PULSE', Date.now().toString());
                this.log("VITALITY_PULSE_CONFIRMED", "#f97316"); // Core Orange
                this.updateTickerDisplay();
            }

            startTicker() {
                setInterval(() => { this.updateTickerDisplay(); }, 1000);
            }

            updateTickerDisplay() {
                const lastPulse = localStorage.getItem('SENTINEL_PULSE');
                if (!lastPulse) return;
                const remaining = (parseInt(lastPulse) + CONFIG.DORMANCY_LIMIT) - Date.now();
                if (remaining < 0) { this.terminate("DORMANCY_LIMIT_REACHED"); return; }
                const d = Math.floor(remaining / (1000 * 60 * 60 * 24));
                const h = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                this.dom.ticker.innerHTML = `SENTINEL_WATCH: ${d}d ${h}h REMAINING`;
                this.dom.ticker.style.color = d < 3 ? '#ff4444' : '#f97316';
            }

            log(msg, color) {
                const entry = document.createElement('div');
                entry.style.color = color;
                entry.innerHTML = `> [${new Date().toLocaleTimeString()}] ${msg}`;
                this.dom.log.prepend(entry);
                localStorage.setItem('SENTINEL_LOGS', this.dom.log.innerHTML);
            }
        }

        const sentinel = new Sentinel();
        let activeAccount = null;

        window.bootSystem = async () => {
            const wallet = createWallet("io.metamask");
            activeAccount = await wallet.connect({ client, chain: coreChain });

            if (activeAccount.address.toLowerCase() !== CONFIG.ADMIN_WALLET) {
                sentinel.terminate("UNAUTHORIZED_IDENTITY_SIGNATURE");
                return;
            }

            if (localStorage.getItem('SENTINEL_LOGS')) document.getElementById('nodeLog').innerHTML = localStorage.getItem('SENTINEL_LOGS');
            if (!localStorage.getItem('SENTINEL_PULSE')) sentinel.pulse();

            document.getElementById('bootBtn').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            sentinel.log("SYSTEM_ONLINE: CORE_DAO_MAINNET_LINKED", "#f97316");
        };

        window.executeMint = async () => {
            const ip = await sentinel.getIP();
            if (ip !== CONFIG.AUTHORIZED_IP) {
                let fails = parseInt(localStorage.getItem('SENTINEL_FLAGS') || '0') + 1;
                localStorage.setItem('SENTINEL_FLAGS', fails);
                if (fails >= 3) sentinel.terminate("SECURITY_PERIMETER_BREACH");
                else alert(`SENTINEL ALERT: IP MISMATCH (${fails}/3)`);
                return;
            }

            try {
                // Ensure the transaction is on Core Chain
                const transaction = prepareContractCall({ 
                    contract, 
                    method: "function mint(address to, uint256 amount)", 
                    params: [activeAccount.address, 1000000000000000000n] 
                });
                await sendTransaction({ transaction, account: activeAccount });
                sentinel.log("CORE_ANCHOR_SUCCESSFUL", "#22c55e");
                sentinel.pulse(); 
            } catch (err) { 
                console.error(err);
                sentinel.log("CORE_TX_FAILED: CHECK_GAS_OR_CONTRACT", "#ff4444"); 
            }
        };

        window.manualPulse = () => sentinel.pulse();
        window.addEventListener('load', () => sentinel.init());
    </script>

    <style>
        :root { --core-orange: #f97316; --alert: #ff4444; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: 'Roboto Mono', monospace; margin: 0; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .terminal { width: 400px; padding: 30px; border: 1px solid #222; background: #000; box-shadow: 0 0 50px rgba(249, 115, 22, 0.2); }
        .header { border-bottom: 1px solid #222; padding-bottom: 10px; margin-bottom: 15px; font-size: 0.8rem; color: #666; display: flex; justify-content: space-between; }
        .btn { width: 100%; padding: 12px; background: transparent; border: 1px solid #333; color: #888; cursor: pointer; font-family: inherit; font-weight: bold; transition: 0.2s; }
        .btn:hover { border-color: var(--core-orange); color: var(--core-orange); box-shadow: 0 0 10px rgba(249, 115, 22, 0.2); }
        .log-window { height: 100px; overflow-y: auto; font-size: 0.6rem; margin-top: 15px; border-top: 1px solid #222; padding-top: 10px; color: #444; }
        .stealth-layer { background: white; color: #333; height: 100vh; width: 100vw; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; font-family: sans-serif; }
        .dead-screen { background: #000; color: var(--alert); height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; }
        .sentinel-box { border: 2px solid var(--alert); padding: 40px; text-align: center; animation: pulseRed 2s infinite; }
        .scan-line { height: 2px; background: var(--alert); width: 100%; margin: 20px 0; box-shadow: 0 0 10px var(--alert); }
        @keyframes pulseRed { 0% { box-shadow: 0 0 10px rgba(255,0,0,0.1); } 50% { box-shadow: 0 0 30px rgba(255,0,0,0.3); } 100% { box-shadow: 0 0 10px rgba(255,0,0,0.1); } }
    </style>
</head>
<body id="appBody">
    <button id="bootBtn" class="btn" onclick="bootSystem()" style="display:none; width: auto; border-color: var(--core-orange); color: var(--core-orange);">INITIALIZE_SENTINEL_CORE</button>
    <div id="ui" class="terminal" style="display:none;">
        <div class="header"><span>OMNIF_NODE_V3.0_CORE</span><span id="vitalityTicker" style="color:var(--core-orange)">SENTINEL_ACTIVE</span></div>
        <button class="btn" onclick="executeMint()">EXECUTE_ANCHOR_PROTOCOL</button>
        <div style="text-align: center; margin-top: 10px;"><span onclick="manualPulse()" style="font-size: 0.55rem; cursor: pointer; text-decoration: underline; color: #444;">[ MANUAL_PULSE_SIGNAL ]</span></div>
        <div id="nodeLog" class="log-window"></div>
    </div>
</body>
</html>
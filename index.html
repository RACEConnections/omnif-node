<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMNIF | Core DAO Terminal</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script type="module">
        import { createThirdwebClient, getContract, prepareContractCall, sendTransaction, defineChain, readContract } from "https://esm.sh/thirdweb";
        import { createWallet } from "https://esm.sh/thirdweb/wallets";

        const CONFIG = {
            AUTHORIZED_IP: "105.119.7.69", 
            ADMIN_WALLET: "0x88d585bd60be1349dd1c6c217d27f87b0351fd0e".toLowerCase(),
            CONTRACT_ADDR: "0xc23F43FE5D5D65b0a094c8A8A712aBd4e820A210", 
            DORMANCY_LIMIT: 30 * 24 * 60 * 60 * 1000 
        };

        const client = createThirdwebClient({ clientId: "53986b5e6984bcd49129531efe1c149c" });
        const coreChain = defineChain(1116);
        const contract = getContract({ client, chain: coreChain, address: CONFIG.CONTRACT_ADDR });

        class Sentinel {
            constructor() {
                this.dom = {
                    body: document.getElementById('appBody'),
                    log: document.getElementById('nodeLog'),
                    ticker: document.getElementById('vitalityTicker'),
                    balance: document.getElementById('tokenBalance'),
                    ui: document.getElementById('ui'),
                    bootBtn: document.getElementById('bootBtn')
                };
            }

            async init() {
                const ip = await this.getIP();
                if (ip !== CONFIG.AUTHORIZED_IP) { this.renderDecoy(); return; }
                this.dom.bootBtn.style.display = 'block';
                this.startTicker();
            }

            async getIP() {
                try {
                    const res = await fetch('https://api.ipify.org?format=json');
                    const data = await res.json();
                    return data.ip;
                } catch { return "0.0.0.0"; }
            }

            renderDecoy() {
                this.dom.body.innerHTML = `<div class="stealth-layer"><h1>503 Service Unavailable</h1></div>`;
            }

            async updateBalance(address) {
                try {
                    const balance = await readContract({ 
                        contract, 
                        method: "function balanceOf(address owner) view returns (uint256)", 
                        params: [address] 
                    });
                    // Convert from Wei (18 decimals) to Human Readable
                    const formatted = (Number(balance) / 10**18).toLocaleString();
                    this.dom.balance.innerHTML = `ASSET_BAL: ${formatted} OMNIF`;
                } catch (err) {
                    this.dom.balance.innerHTML = `ASSET_BAL: SYNC_ERROR`;
                }
            }

            log(msg, color) {
                const entry = document.createElement('div');
                entry.style.color = color;
                entry.innerHTML = `> [${new Date().toLocaleTimeString()}] ${msg}`;
                this.dom.log.prepend(entry);
            }

            startTicker() {
                setInterval(() => {
                    const lastPulse = localStorage.getItem('SENTINEL_PULSE');
                    if (!lastPulse) return;
                    const remaining = (parseInt(lastPulse) + CONFIG.DORMANCY_LIMIT) - Date.now();
                    const d = Math.floor(remaining / (1000 * 60 * 60 * 24));
                    this.dom.ticker.innerHTML = `WATCH: ${d}d REMAINING`;
                }, 1000);
            }
        }

        const sentinel = new Sentinel();
        let activeAccount = null;

        window.bootSystem = async () => {
            const wallet = createWallet("io.metamask");
            activeAccount = await wallet.connect({ client, chain: coreChain });

            if (activeAccount.address.toLowerCase() !== CONFIG.ADMIN_WALLET) return;

            document.getElementById('bootBtn').style.display = 'none';
            document.getElementById('ui').style.display = 'block';
            sentinel.log("CORE_MAINNET_LIVE", "#f97316");
            
            // Initial Balance Fetch
            sentinel.updateBalance(activeAccount.address);
        };

        window.executeMint = async () => {
            try {
                const transaction = prepareContractCall({ 
                    contract, 
                    method: "function mint(address to, uint256 amount)", 
                    params: [activeAccount.address, 1000000000000000000n] 
                });
                await sendTransaction({ transaction, account: activeAccount });
                sentinel.log("ANCHOR_SUCCESS", "#22c55e");
                // Refresh balance after mint
                setTimeout(() => sentinel.updateBalance(activeAccount.address), 3000);
            } catch (err) { 
                sentinel.log("TX_FAILED", "#ff4444"); 
            }
        };

        window.addEventListener('load', () => sentinel.init());
    </script>

    <style>
        :root { --core-orange: #f97316; --bg: #050505; }
        body { background: var(--bg); color: white; font-family: 'Roboto Mono', monospace; margin: 0; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .terminal { width: 420px; padding: 30px; border: 1px solid #222; background: #000; box-shadow: 0 0 40px rgba(249, 115, 22, 0.1); }
        .header { border-bottom: 1px solid #222; padding-bottom: 10px; margin-bottom: 15px; font-size: 0.75rem; color: #666; display: flex; justify-content: space-between; flex-direction: column; gap: 5px; }
        .watchlist { color: var(--core-orange); font-weight: bold; font-size: 0.85rem; border: 1px solid #111; padding: 5px; background: #080808; text-align: center; }
        .btn { width: 100%; padding: 12px; background: transparent; border: 1px solid #333; color: #888; cursor: pointer; font-family: inherit; font-weight: bold; margin-top: 10px; }
        .btn:hover { border-color: var(--core-orange); color: var(--core-orange); }
        .log-window { height: 100px; overflow-y: auto; font-size: 0.6rem; margin-top: 15px; border-top: 1px solid #222; padding-top: 10px; color: #444; }
        .stealth-layer { height: 100vh; width: 100vw; display: flex; align-items: center; justify-content: center; background: white; color: black; }
    </style>
</head>
<body id="appBody">
    <button id="bootBtn" class="btn" onclick="bootSystem()" style="display:none; width: auto; border-color: var(--core-orange); color: var(--core-orange);">INITIALIZE_SENTINEL_V3.1</button>
    <div id="ui" class="terminal" style="display:none;">
        <div class="header">
            <div style="display: flex; justify-content: space-between;">
                <span>NODE_V3.1</span>
                <span id="vitalityTicker" style="color:var(--core-orange)">SENTINEL_ACTIVE</span>
            </div>
            <div id="tokenBalance" class="watchlist">FETCHING_ASSETS...</div>
        </div>
        <button class="btn" onclick="executeMint()">EXECUTE_ANCHOR_PROTOCOL</button>
        <div id="nodeLog" class="log-window"></div>
    </div>
</body>
</html>
